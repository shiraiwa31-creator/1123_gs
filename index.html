<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>janken-shinka</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
      <div id="game">
    <h1>é–“é•ã„æ¢ã—</h1>
    <div class="info">
      åŒã˜é¡”ãŒä¸¦ã¶ä¸­ã«ã€1ã¤ã ã‘é•ã†é¡”ãŒã‚ã‚‹ã‚ˆã€‚<br>
      30ç§’ä»¥å†…ã«ã§ãã‚‹ã ã‘ãŸãã•ã‚“å½“ã¦ã¦ã­ï¼
    </div>

    
    <div class="status">
      <div>ãƒ¬ãƒ™ãƒ«ï¼š<span id="level">1</span></div>
      <div>ã‚¯ãƒªã‚¢ï¼š<span id="clears">0</span> å›</div>
      <div>æ®‹ã‚Šï¼š<span id="time">30</span> ç§’</div>
    </div>

    <div class="board">
    <div class="grid" id="grid"></div>
    </div>
    <div id="message"></div>

    <button id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>

const normalFace = "ğŸ˜‰"; 
const oddFace    = "ğŸ˜Š";

let oddIndex = -1;
let level = 1;
let clears = 0;
let timeLeft = 30;
let timerId = null;
let gameActive = false;

// è¦ç´ ã‚­ãƒ£ãƒƒã‚·ãƒ¥
const $grid   = $("#grid");
const $msg    = $("#message");
const $level  = $("#level");
const $clears = $("#clears");
const $time   = $("#time");
const $start  = $("#startBtn");
const $game   = $("#game");

function getGridSizeFromLevel(lv) {
  if (lv === 1) return 3 * 3;   // 9
  if (lv === 2) return 4 * 4;   // 16
  return 5 * 5;                 // 25
}

function applyGridLayout(gridCount) {
  const side = Math.sqrt(gridCount);
  $grid.css("grid-template-columns", `repeat(${side}, 1fr)`);
}

function setupGame() {
  const cellCount = getGridSizeFromLevel(level);
  applyGridLayout(cellCount);

  $grid.html("");
  $msg.text("");

  oddIndex = Math.floor(Math.random() * cellCount);

  for (let i = 0; i < cellCount; i++) {
    const face = (i === oddIndex) ? oddFace : normalFace;
    const $cell = $(`
      <div class="cell" data-index="${i}">
        ${face}
      </div>
    `);

    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆjQueryç‰ˆï¼‰
    $cell.on("click", function () {
      onCellClick($(this));
    });

    $grid.append($cell);
  }
}

function onCellClick($cell) {
  if (!gameActive) return;

  const index = Number($cell.data("index"));

  if (index === oddIndex) {
    // æ­£è§£
    clears++;
    level++;
    $clears.text(clears);
    $level.text(level);
    setupGame(); 
  } else {
    shakeScreen();
  }
}

function shakeScreen() {
  $game.removeClass("shake");
  void $game[0].offsetWidth; // DOMãƒªãƒ•ãƒ­ãƒ¼
  $game.addClass("shake");
}

function startTimer() {
  timeLeft = 30;
  $time.text(timeLeft);

  if (timerId) clearInterval(timerId);

  timerId = setInterval(() => {
    timeLeft--;
    $time.text(timeLeft);

    if (timeLeft <= 0) {
      clearInterval(timerId);
      gameActive = false;
      $msg.text(`ãŠã‚ã§ã¨ã†ï¼ ${clears}å›é”æˆ`);
      $start.prop("disabled", false).text("ã‚‚ã†ä¸€åº¦");
    }
  }, 1000);
}

function startGame() {
  level = 1;
  clears = 0;
  $level.text(level);
  $clears.text(clears);
  $msg.text("");

  gameActive = true;
  $start.prop("disabled", true);

  setupGame();
  startTimer();
}

// ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
$start.on("click", startGame);

setupGame();

</script>
</body>
</html>